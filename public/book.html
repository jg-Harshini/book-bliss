<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Book Details - BookBliss</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f4f4f4; color: #333; }
    .sidebar { width: 180px; background-color: #9b5de5; color: white; padding-top: 20px; display: flex; flex-direction: column; align-items: center; gap: 20px; position: fixed; height: 100vh; }
    .logo { font-size: 1.5rem; margin-bottom: 20px; display: flex; gap: 10px; align-items: center; text-align: center; }
    .sidebar button { background: none; color: white; border: none; padding: 10px; cursor: pointer; width: 100%; text-align: center; }
    main { margin-left: 180px; padding: 20px; max-width: 800px; }
    .book-details { display: flex; gap: 20px; margin-bottom: 40px; flex-wrap: wrap; }
    .book-cover { width: 180px; height: auto; border-radius: 8px; box-shadow: 0 0 8px rgba(0,0,0,0.2); }
    .info h1 { margin: 0 0 10px; }
    .rating .star { font-size: 20px; color: gold; margin-right: 3px; }
    .author-info { display: flex; gap: 20px; margin-top: 10px; flex-wrap: wrap; }
    .author-info img { width: 120px; height: auto; border-radius: 10px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
    .comment-section { margin-top: 50px; }
    .comment-section h2 { margin-bottom: 10px; }
    .comment-box textarea {
      width: 100%; height: 80px; padding: 10px; font-family: inherit;
      border: 1px solid #ccc; border-radius: 6px;
    }
    .comment-box button {
      margin-top: 10px; padding: 8px 16px; background-color: #9b5de5;
      border: none; color: white; border-radius: 4px; cursor: pointer;
    }
    .comment-list { margin-top: 20px; }
    .comment {
      background: white; border: 1px solid #ddd; padding: 10px 15px;
      border-radius: 6px; margin-bottom: 10px; position: relative;
    }
    .comment button {
      position: absolute; top: 10px; right: 10px; border: none;
      background: #ff4d4d; color: white; padding: 2px 8px;
      font-size: 12px; border-radius: 4px; cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="logo">üìñ<br/>BookBliss</div>
    <button onclick="location.href='index.html'">Home</button>
    <button onclick="location.href='browse.html'">Browse</button>
    <button onclick="location.href='community.html'">Community</button>
    <button onclick="location.href='settings.html'">Settings</button>
    <button onclick="location.href='about.html'">About</button>
    <button onclick="location.href='ai.html'">AI Support</button>
  </div>

  <main>
    <header>
      <a href="index.html" class="back-btn">‚Üê Back to home</a>
    </header>

    <section class="book-details">
      <img id="book-cover" class="book-cover" alt="Book cover" />
      <div class="info">
        <h1 id="book-title"></h1>
        <p class="pub-date">Published year: <span id="pub-date"></span></p>
        <p class="description" id="book-description"></p>
        <div class="rating" id="book-rating"></div>
      </div>
    </section>

    <section class="author">
      <h2>About author <span>‚Üí</span></h2>
      <div class="author-info">
        <img id="author-img" src="images/author.jpg" alt="Author Image" />
        <div>
          <h3 id="author-name"></h3>
          <p id="author-bio">Bio not available</p>
        </div>
      </div>
    </section>

    <section class="comment-section">
      <h2>Comments</h2>
      <div class="comment-box">
        <textarea id="comment-input" placeholder="Write your comment here..."></textarea>
        <button onclick="addComment()">Post Comment</button>
      </div>
      <div class="comment-list" id="comment-list"></div>
    </section>
  </main>

  <script>
    // --- Utility to get query param ---
    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    const bookId = getQueryParam('id');

    async function fetchBook() {
      if (!bookId) return alert('Book ID not found in URL!');
      try {
        const res = await fetch(`/api/books/${bookId}`);
        if (!res.ok) throw new Error('Book not found');
        const book = await res.json();

        // Populate book details
        document.getElementById('book-title').textContent = book.title;
        document.getElementById('book-cover').src = book.cover;
        document.getElementById('book-cover').alt = book.title + " cover";
        document.getElementById('pub-date').textContent = book.year;
        document.getElementById('book-description').textContent = `Genre: ${book.genre}`;

        // Render rating stars
        const starContainer = document.getElementById('book-rating');
        starContainer.innerHTML = '';
        const fullStars = Math.floor(book.rating);
        const hasHalf = book.rating % 1 >= 0.5;
        for (let i = 0; i < fullStars; i++) starContainer.innerHTML += '<span class="star">‚òÖ</span>';
        if (hasHalf) starContainer.innerHTML += '<span class="star">‚òÖ</span>';

        // Author info (static for now)
        document.getElementById('author-name').textContent = book.author;

      } catch (err) {
        console.error(err);
        alert('Error fetching book details');
      }
    }

    fetchBook();

    // --- Comment Service ---
    class CommentService {
      constructor() { this.comments = []; }
      getAll() { return this.comments; }
      add(text) { const id = Date.now(); const comment = { id, text }; this.comments.unshift(comment); return comment; }
      delete(id) { this.comments = this.comments.filter(c => c.id !== id); }
    }

    const commentService = new CommentService();
    const listEl = document.getElementById('comment-list');

    function renderComments() {
      listEl.innerHTML = '';
      commentService.getAll().forEach(comment => {
        const div = document.createElement('div');
        div.className = 'comment';
        div.innerHTML = `<p>${comment.text}</p>
                         <button onclick="deleteComment(${comment.id})">Delete</button>`;
        listEl.appendChild(div);
      });
    }

    function addComment() {
      const input = document.getElementById('comment-input');
      const text = input.value.trim();
      if (text) { commentService.add(text); input.value = ''; renderComments(); }
    }

    function deleteComment(id) { commentService.delete(id); renderComments(); }
    renderComments();
  </script>
</body>
</html>
