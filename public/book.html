<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Book Details - BookBliss</title>
  <style>
    body { 
      font-family: 'Segoe UI', sans-serif; 
      margin: 0; 
      background: #f9f6ff; 
      color: #333; 
      display: flex;
    }

    /* === Sidebar === */
    .sidebar { 
      width: 220px; 
      background: linear-gradient(180deg, #9b5de5, #6a0dad);
      color: white; 
      padding: 20px 0; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      position: fixed; 
      height: 100vh; 
      box-shadow: 2px 0 10px rgba(0,0,0,0.2);
    }

    .logo { 
      font-size: 1.7rem; 
      font-weight: bold; 
      margin-bottom: 40px; 
      display: flex; 
      align-items: center; 
      gap: 10px; 
    }

    .sidebar button { 
      background: none; 
      color: white; 
      border: none; 
      padding: 12px 20px; 
      cursor: pointer; 
      width: 100%; 
      text-align: left; 
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background 0.3s;
    }

    .sidebar button:hover { 
      background: rgba(255, 255, 255, 0.15); 
    }

    /* === Main Content === */
    main { 
      margin-left: 220px; 
      padding: 30px; 
      max-width: 900px; 
      width: 100%; 
    }

    header .back-btn { 
      text-decoration: none; 
      color: #6a0dad; 
      font-weight: bold; 
      margin-bottom: 20px; 
      display: inline-block;
    }

    /* === Book Details Card === */
    .book-details { 
      display: flex; 
      gap: 20px; 
      flex-wrap: wrap; 
      background: white; 
      padding: 20px; 
      border-radius: 12px; 
      box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
      margin-bottom: 30px;
    }

    .book-cover { 
      width: 200px; 
      height: auto; 
      border-radius: 12px; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.2); 
    }

    .info h1 { 
      margin: 0 0 15px; 
      font-size: 1.8rem; 
      color: #4b0082;
    }

    .pub-date { 
      color: #777; 
      margin-bottom: 10px;
    }

    .rating .star { 
      font-size: 22px; 
      color: gold; 
      margin-right: 2px; 
    }

    /* === Author Section === */
    .author { 
      background: white; 
      padding: 20px; 
      border-radius: 12px; 
      box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
      margin-bottom: 30px;
    }

    .author h2 { 
      margin-top: 0; 
      color: #6a0dad; 
    }

    .author-info { 
      display: flex; 
      gap: 20px; 
      margin-top: 15px; 
      flex-wrap: wrap; 
      align-items: flex-start;
    }

    .author-info img { 
      width: 140px; 
      height: auto; 
      border-radius: 12px; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.15); 
    }

    /* === Comments Section === */
    .comment-section { 
      background: white; 
      padding: 20px; 
      border-radius: 12px; 
      box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
    }

    .comment-section h2 { 
      margin-top: 0; 
      color: #6a0dad;
    }

    .comment-box textarea {
      width: 100%; 
      height: 90px; 
      padding: 10px; 
      border: 1px solid #ccc; 
      border-radius: 8px; 
      font-family: inherit;
    }

    .comment-box button {
      margin-top: 12px; 
      padding: 10px 18px; 
      background-color: #9b5de5; 
      border: none; 
      color: white; 
      border-radius: 6px; 
      cursor: pointer; 
      font-weight: bold; 
      transition: background 0.3s;
    }

    .comment-box button:hover { 
      background-color: #7d3ccb; 
    }

    .comment-list { 
      margin-top: 20px; 
    }

    .comment {
      background: #fafafa; 
      border: 1px solid #ddd; 
      padding: 12px 16px; 
      border-radius: 8px; 
      margin-bottom: 12px; 
      position: relative;
    }

    .comment button {
      position: absolute; 
      top: 10px; 
      right: 10px; 
      border: none; 
      background: #ff4d4d; 
      color: white; 
      padding: 4px 10px; 
      font-size: 12px; 
      border-radius: 6px; 
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="logo">üìñ BookBliss</div>
    <button onclick="location.href='index.html'">üè† Home</button>
    <button onclick="location.href='browse.html'">üìö Browse</button>
    <button onclick="location.href='community.html'">üí¨ Community</button>
    <button onclick="location.href='settings.html'">‚öôÔ∏è Settings</button>
    <button onclick="location.href='about.html'">‚ÑπÔ∏è About</button>
    <button onclick="location.href='ai.html'">ü§ñ AI Support</button>
  </div>

  <!-- Main -->
  <main>
    <header>
      <a href="index.html" class="back-btn">‚Üê Back to home</a>
    </header>

    <!-- Book Details -->
    <section class="book-details">
      <img id="book-cover" class="book-cover" alt="Book cover" />
      <div class="info">
        <h1 id="book-title"></h1>
        <p class="pub-date">Published year: <span id="pub-date"></span></p>
        <p class="description" id="book-description"></p>
        <div class="rating" id="book-rating"></div>
      </div>
    </section>

    <!-- Author -->
    <section class="author">
      <h2>About Author</h2>
      <div class="author-info">
        <img id="author-img" src="images/default-author.jpg" alt="Author Image" />
        <div>
          <h3 id="author-name"></h3>
          <p id="author-bio">Bio not available</p>
        </div>
      </div>
    </section>

    <!-- Comments -->
    <section class="comment-section">
      <h2>Comments</h2>
      <div class="comment-box">
        <textarea id="comment-input" placeholder="Write your comment here..."></textarea>
        <button onclick="addComment()">Post Comment</button>
      </div>
      <div class="comment-list" id="comment-list"></div>
    </section>
  </main>


  <script>
  // helper: get query param
  function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
  }
  const bookId = getQueryParam('id');

  async function resolveAuthor(authorField) {
    try {
      if (!authorField) return null;
      if (typeof authorField === 'object') {
        if (authorField.name) return authorField;
        if (authorField._id) {
          const r = await fetch(`/api/authors/${authorField._id}`);
          if (r.ok) return await r.json();
          return null;
        }
      }
      if (typeof authorField === 'string') {
        const idRegex = /^[0-9a-fA-F]{24}$/;
        if (idRegex.test(authorField)) {
          const r = await fetch(`/api/authors/${authorField}`);
          if (r.ok) return await r.json();
          return null;
        }
        const r = await fetch('/api/authors');
        if (!r.ok) return null;
        const list = await r.json();
        const found = list.find(a => a.name && a.name.toLowerCase() === authorField.toLowerCase());
        return found || null;
      }
      return null;
    } catch (e) {
      console.error('resolveAuthor error:', e);
      return null;
    }
  }

  function applyAuthorToDOM(author) {
    const nameEl = document.getElementById('author-name');
    const bioEl  = document.getElementById('author-bio');
    const imgEl  = document.getElementById('author-img');
    if (!nameEl || !bioEl || !imgEl) return;

    if (author) {
      nameEl.textContent = author.name || 'Unknown author';
      bioEl.textContent = author.detail || 'No bio available';
      imgEl.src = author.photo || 'images/default-author.jpg';
      imgEl.alt = `Photo of ${author.name || 'author'}`;
    } else {
      nameEl.textContent = 'Author information not available';
      bioEl.textContent = 'No bio available';
      imgEl.src = 'images/default-author.jpg';
      imgEl.alt = 'Default author photo';
    }
    imgEl.onerror = () => { imgEl.src = 'images/default-author.jpg'; };
  }

  async function fetchBook() {
    if (!bookId) { alert('Book ID not found in URL!'); return; }
    try {
      const res = await fetch(`/api/books/${bookId}`);
      if (!res.ok) throw new Error('Book not found');
      const book = await res.json();
      console.log('Book API response:', book);

      document.getElementById('book-title').textContent = book.title || 'Untitled';
      document.getElementById('book-cover').src = book.cover || 'images/default-cover.jpg';
      document.getElementById('pub-date').textContent = book.year || 'Unknown';
      document.getElementById('book-description').textContent = book.genre ? `Genre: ${book.genre}` : 'Genre: N/A';

      const starContainer = document.getElementById('book-rating');
      starContainer.innerHTML = '';
      const ratingNum = Number(book.rating) || 0;
      const fullStars = Math.floor(ratingNum);
      const hasHalf = (ratingNum - fullStars) >= 0.5;
      for (let i = 0; i < fullStars; i++) starContainer.innerHTML += '<span class="star">‚òÖ</span>';
      if (hasHalf) starContainer.innerHTML += '<span class="star">‚òÖ</span>';

      const resolvedAuthor = await resolveAuthor(book.author);
      applyAuthorToDOM(resolvedAuthor);

    } catch (err) {
      console.error('Error fetching book details:', err);
      applyAuthorToDOM(null);
    }
  }

  class CommentService {
    constructor() { this.comments = []; }
    getAll() { return this.comments; }
    add(text) { const id = Date.now(); const comment = { id, text }; this.comments.unshift(comment); return comment; }
    delete(id) { this.comments = this.comments.filter(c => c.id !== id); }
  }
  const commentService = new CommentService();
  const listEl = document.getElementById('comment-list');

  function renderComments() {
    listEl.innerHTML = '';
    commentService.getAll().forEach(comment => {
      const div = document.createElement('div');
      div.className = 'comment';
      div.innerHTML = `<p>${comment.text}</p>
                       <button onclick="deleteComment(${comment.id})">Delete</button>`;
      listEl.appendChild(div);
    });
  }

  function addComment() {
    const input = document.getElementById('comment-input');
    const text = input.value.trim();
    if (text) { commentService.add(text); input.value = ''; renderComments(); }
  }
  function deleteComment(id) { commentService.delete(id); renderComments(); }

  fetchBook();
  renderComments();
  </script>
</body>
</html>
